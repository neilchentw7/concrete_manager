# é æ‹Œæ··å‡åœŸå‡ºè»Šç®¡ç†ç³»çµ± v2

## ğŸ¯ ç³»çµ±æ”¹é€²é‡é»

### è³‡æ–™åº«ç°¡åŒ–

| èˆŠè¨­è¨ˆ | æ–°è¨­è¨ˆ | æ”¹é€² |
|--------|--------|------|
| `price_tables` 200+ ç­† | `project_prices` ç²¾ç°¡ | å·¥ç¨‹Ã—é…æ¯”=ä¸€å€‹å–®åƒ¹ï¼Œä¸å†æŒ‰è¼‰é‡åˆ† |
| `dispatch_logs` ä¸å­˜è¨ˆç®—çµæœ | `dispatches` é å­˜æ‰€æœ‰æ•¸å€¼ | æŸ¥è©¢å ±è¡¨ä¸ç”¨é‡ç®— |
| `material_prices` + `mix_designs` è¤‡é›œ | `mixes` ç›´æ¥å­˜æˆæœ¬ | ä¸€å€‹æ¬„ä½æå®šææ–™æˆæœ¬ |
| å·¥ç¨‹ç¼ºé è¨­è·é›¢ | `projects.default_distance_km` | å‡ºè»Šä¸ç”¨æ¯æ¬¡å¡«è·é›¢ |

### æ–°è³‡æ–™è¡¨çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  projects   â”‚â”€â”€â”€â”€â–¶â”‚project_pricesâ”‚â—€â”€â”€â”€â”€â”‚   mixes     â”‚
â”‚  å·¥ç¨‹/æ¡ˆå ´  â”‚     â”‚   å–®åƒ¹è¡¨    â”‚     â”‚    é…æ¯”     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                       â”‚
       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ dispatches  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚  å‡ºè»Šç´€éŒ„   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–²
                          â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   trucks    â”‚
                   â”‚    è»Šè¼›     â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‡ºè»Šç´€éŒ„é å­˜æ‰€æœ‰è¨ˆç®—

```sql
dispatches è¡¨åŒ…å«ï¼š
â”œâ”€â”€ åŸºæœ¬è³‡æ–™ï¼šdate, project_id, mix_id, truck_id, load_m3, distance_km
â”œâ”€â”€ æ”¶å…¥ï¼šrevenue, subsidy, total_revenue
â”œâ”€â”€ æˆæœ¬ï¼šmaterial_cost, fuel_cost, driver_cost, total_cost
â””â”€â”€ æ¯›åˆ©ï¼šgross_profit, profit_margin
```

**å¥½è™•**ï¼šæŸ¥è©¢å ±è¡¨æ™‚ç›´æ¥ SUMï¼Œä¸ç”¨æ¯æ¬¡ JOIN é‡ç®—ï¼

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. å®‰è£ä¾è³´
```bash
pip install -r requirements.txt
```

### 2. å¾èˆŠè³‡æ–™åº«é·ç§»ï¼ˆå¦‚æœ‰ï¼‰
```bash
# æŠŠèˆŠçš„ concrete_profit.db æ”¾åˆ°ä¸Šå±¤ç›®éŒ„
python migrate.py ../concrete_profit.db
```

### 3. å•Ÿå‹•æœå‹™
```bash
python app.py
# æˆ–
uvicorn app:app --reload --port 8000
```

### 4. é–‹å•Ÿç€è¦½å™¨
- Web ä»‹é¢ï¼šhttp://localhost:8000
- API æ–‡ä»¶ï¼šhttp://localhost:8000/docs

---

## ğŸ“¡ API ç«¯é»

### åŸºç¤è³‡æ–™ CRUD

```bash
# å·¥ç¨‹
GET    /api/projects              # åˆ—å‡ºæ‰€æœ‰
POST   /api/projects              # æ–°å¢
GET    /api/projects/{id}         # å–å¾—å–®ä¸€
PUT    /api/projects/{id}         # æ›´æ–°

# è»Šè¼›
GET    /api/trucks
POST   /api/trucks

# é…æ¯”
GET    /api/mixes
POST   /api/mixes

# å–®åƒ¹
GET    /api/prices?project_id=1
POST   /api/prices
```

### å‡ºè»Šï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

```bash
# é è¦½
POST /api/dispatch/preview
{
  "date": "2025-01-15",
  "project": "å°åŒ—å·¥åœ°",
  "items": [
    {"truck": "ç‹å¸æ©Ÿ", "load": 8},
    {"truck": "æå¸æ©Ÿ", "load": 8, "psi": "4000"}
  ]
}

# ç¢ºèªå¯«å…¥
POST /api/dispatch/commit
(åŒä¸Šæ ¼å¼)

# æŸ¥è©¢
GET /api/dispatches?start_date=2025-01-01&end_date=2025-01-31&project_code=BIG01
```

### å ±è¡¨

```bash
# æ—¥å ±è¡¨
GET /api/reports/daily?date_str=2025-01-15

# æœˆå ±è¡¨
GET /api/reports/monthly?year=2025&month=1

# å·¥ç¨‹å ±è¡¨
GET /api/reports/project/BIG01?start_date=2025-01-01
```

### è¨­å®š

```bash
# æŸ¥çœ‹è¨­å®š
GET /api/settings

# æ›´æ–°æ²¹åƒ¹
PUT /api/settings/fuel_price?value=33.5
```

---

## ğŸ“‹ CSV ä¸Šå‚³æ ¼å¼

### å®Œæ•´ç‰ˆ
```csv
date,project,truck,load,psi,distance
2025-01-15,å°åŒ—å·¥åœ°,ç‹å¸æ©Ÿ,8,3000,12
2025-01-15,é«˜é›„å·¥åœ°,æå¸æ©Ÿ,9,4000,20
```

### ç°¡åŒ–ç‰ˆï¼ˆæ­é…é è¨­æ—¥æœŸ+å·¥ç¨‹ï¼‰
```csv
truck,load
ç‹å¸æ©Ÿ,8
æå¸æ©Ÿ,8
é™³å¸æ©Ÿ,9
```

---

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
concrete_v2/
â”œâ”€â”€ app.py           # FastAPI ä¸»ç¨‹å¼ + Web ä»‹é¢
â”œâ”€â”€ models.py        # SQLAlchemy ORM æ¨¡å‹
â”œâ”€â”€ calculator.py    # å‡ºè»Šè¨ˆç®—å¼•æ“
â”œâ”€â”€ migrate.py       # è³‡æ–™é·ç§»å·¥å…·
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```

---

## ğŸ”¢ è¨ˆç®—å…¬å¼

### æ”¶å…¥
```
åŸºæœ¬æ”¶å…¥ = è¼‰é‡ Ã— å–®åƒ¹(æ¯mÂ³)
çŸ­å°‘è£œè²¼ = è¼‰é‡ < é–€æª» ? è£œè²¼é‡‘é¡ : 0
ç¸½æ”¶å…¥ = åŸºæœ¬æ”¶å…¥ + è£œè²¼
```

### æˆæœ¬
```
ææ–™æˆæœ¬ = è¼‰é‡ Ã— é…æ¯”ææ–™æˆæœ¬(æ¯mÂ³)
æ²¹æ–™æˆæœ¬ = è·é›¢ Ã— 2(ä¾†å›) Ã— æ²¹è€—(L/km) Ã— æ²¹åƒ¹
å¸æ©Ÿæˆæœ¬ = æ¯è¶Ÿå·¥è³‡
ç¸½æˆæœ¬ = ææ–™ + æ²¹æ–™ + å¸æ©Ÿ
```

### æ¯›åˆ©
```
æ¯›åˆ© = ç¸½æ”¶å…¥ - ç¸½æˆæœ¬
æ¯›åˆ©ç‡ = æ¯›åˆ© / ç¸½æ”¶å…¥ Ã— 100%
```

---

## ğŸ’¡ èˆ‡èˆŠç³»çµ±çš„å·®ç•°

| åŠŸèƒ½ | èˆŠç³»çµ± (Streamlit) | æ–°ç³»çµ± (FastAPI) |
|------|-------------------|------------------|
| æ¡†æ¶ | Streamlit | FastAPI |
| API | ç„¡ | REST API |
| å‡ºè»Šæµç¨‹ | æ¯è¡Œå¡«6æ¬„ | æ‰¹æ¬¡æ¨¡å¼ï¼Œé‡è¤‡æ¬„ä½åªå¡«ä¸€æ¬¡ |
| å–®åƒ¹è¡¨ | å·¥ç¨‹Ã—é…æ¯”Ã—è¼‰é‡ | å·¥ç¨‹Ã—é…æ¯” |
| å‡ºè»Šç´€éŒ„ | ä¸å­˜è¨ˆç®—çµæœ | é å­˜æ‰€æœ‰æ•¸å€¼ |
| å ±è¡¨æ•ˆèƒ½ | æ¯æ¬¡é‡ç®— | ç›´æ¥æŸ¥è©¢ |
| å¤–éƒ¨æ•´åˆ | å›°é›£ | æ”¯æ´ Excel VBA ç­‰ |

---

## ğŸ”§ é€²éšè¨­å®š

### æ›´æ›è³‡æ–™åº«

ä¿®æ”¹ `models.py`ï¼š
```python
# SQLiteï¼ˆé è¨­ï¼‰
DATABASE_URL = "sqlite:///concrete_v2.db"

# PostgreSQL
DATABASE_URL = "postgresql://user:pass@localhost/dbname"

# MySQL
DATABASE_URL = "mysql+pymysql://user:pass@localhost/dbname"
```

### éƒ¨ç½²åˆ°ä¼ºæœå™¨

```bash
# ä½¿ç”¨ gunicorn
pip install gunicorn
gunicorn app:app -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000
```
